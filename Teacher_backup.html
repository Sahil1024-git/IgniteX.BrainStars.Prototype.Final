<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IgniteX - Teacher Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Fredoka One', cursive;
            background-color: #F8F4EE;
            color: #3C3744;
            overflow: hidden;
            position: relative;
        }
        body::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150vw;
            height: 150vw;
            background: radial-gradient(circle, rgba(255, 165, 0, 0.05) 0%, rgba(248, 244, 238, 0) 60%);
            z-index: -1;
        }
        .container {
            background-color: #E5E0DA;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 800px;
            animation: fadeIn 0.5s ease-in-out;
            max-height: 90vh;
            overflow-y: auto;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            background-color: #F8F4EE;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .header-button {
            background-color: #DC143C;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            transition: transform 0.2s, background-color 0.2s;
        }
        .header-button:hover {
            transform: scale(1.05);
            background-color: #FF4500;
        }
        .text-crimson {
            color: #DC143C;
        }
        .text-dark-orange {
            color: #FF4500;
        }
        .logout-btn {
            background-color: #3C3744;
            color: #F8F4EE;
        }
        .logout-btn:hover {
            background-color: #5C5764;
        }
        .delete-btn {
            background-color: #DC143C;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            transition: transform 0.2s, background-color 0.2s;
        }
        .delete-btn:hover {
            transform: scale(1.05);
            background-color: #FF0000;
        }
        .password-btn {
            background-color: #DC143C;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            transition: transform 0.2s, background-color 0.2s;
        }
        .password-btn:hover {
            transform: scale(1.05);
            background-color: #00008B;
        }
        .username-btn {
            background-color: #DC143C;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            transition: transform 0.2s, background-color 0.2s;
        }
        .username-btn:hover {
            transform: scale(1.05);
            background-color: #008080;
        }
        input, select, textarea {
            padding: 1rem;
            border: 2px solid #D1D5DB;
            border-radius: 0.5rem;
            background-color: #F8F4EE;
            color: #3C3744;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #DC143C;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background-color: #E5E0DA;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 400px;
        }
        .dropdown-menu {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background-color: #E5E0DA;
            border-radius: 0.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 100;
            min-width: 200px;
            transform-origin: top right;
            animation: scaleIn 0.2s ease-in-out;
        }
        .dropdown-menu button {
            display: block;
            width: 100%;
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #D1D5DB;
            color: #3C3744;
        }
        .dropdown-menu button:last-child {
            border-bottom: none;
        }
        .dropdown-menu button:hover {
            background-color: #DC143C;
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .delete-marks-btn {
            background-color: #DC143C;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            transition: transform 0.2s, background-color 0.2s;
        }
        .delete-marks-btn:hover {
            background-color: #FF0000;
        }
        .student-card {
            cursor: pointer;
            user-select: none;
        }
        .student-details {
            display: none;
            padding-top: 1rem;
        }
        .student-details.visible {
            display: block;
        }
        .marks-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .marks-table th, .marks-table td {
            border: 1px solid #D1D5DB;
            padding: 0.75rem;
            text-align: left;
        }
        .marks-table th {
            background-color: #E5E0DA;
            font-weight: bold;
        }
        /* New styles for edit/delete buttons in marks table */
        .action-button {
            background-color: #3C3744; /* Darker primary color */
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 9999px; /* Fully curved */
            transition: background-color 0.2s ease-in-out;
            margin-right: 0.5rem;
            border: none;
            cursor: pointer;
        }
        .action-button:hover {
            background-color: #DC143C; /* Crimson on hover */
        }
        .action-button.delete {
            background-color: #DC143C; /* Red for delete button */
        }
        .action-button.delete:hover {
            background-color: #FF0000; /* Darker red on hover for delete */
        }
        /* Style for the input field when editing marks */
        .marks-table input[type="number"] {
            padding: 0.2rem 0.5rem;
            border-radius: 0.3rem;
            border: 1px solid #D1D5DB;
            width: 60px; /* Adjust width as needed */
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div class="container">
        <header class="flex justify-between items-center mb-10 pb-4 border-b-2 border-[#DC143C] relative z-20">
            <h1 class="text-4xl font-bold text-crimson">
                Hello, <span id="teacher-name">Teacher</span>! ðŸ‘‹
            </h1>
            <div class="flex items-center space-x-4">
                <button id="logout-btn" class="header-button logout-btn">Logout</button>
                <div class="relative">
                    <button id="menu-toggle-btn" class="p-2 rounded-full hover:bg-[#F0EDE8] transition-colors duration-200">
                        <svg class="w-6 h-6 text-[#3C3744]" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path>
                        </svg>
                    </button>
                    <div id="menu-dropdown" class="dropdown-menu hidden">
                        <button id="change-username-btn">Change Username</button>
                        <button id="change-password-btn">Change Password</button>
                        <button id="delete-account-btn" class="text-red-500">Delete Account</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="space-y-8">
            <section>
                <h2 class="text-3xl font-bold text-dark-orange mb-4 cursor-pointer" id="toggle-students">My Students</h2>
                <div id="student-list" class="space-y-4">
                    </div>
            </section>
            
            <section>
                <h2 class="text-3xl font-bold text-dark-orange mb-4 cursor-pointer" id="toggle-comments">Parent Comments</h2>
                <div id="comments-list" class="space-y-4">
                    </div>
            </section>

            <section>
                <h2 class="text-3xl font-bold text-dark-orange mb-4">Create New Assignment</h2>
                <form id="assignment-form" class="flex flex-col space-y-4">
                    <input type="text" id="assignment-title" placeholder="Assignment Title" required>
                    <input type="text" id="assignment-subject" placeholder="Subject" required>
                    <input type="date" id="assignment-due-date" required>
                    <button type="submit" class="header-button">Assign Homework</button>
                </form>
            </section>
            
            <section>
                <h2 class="text-3xl font-bold text-dark-orange mb-4">Post Notes & Resources</h2>
                <form id="notes-form" class="flex flex-col space-y-4">
                    <input type="text" id="note-title" placeholder="Note Title" required>
                    <textarea id="note-content" placeholder="Type your notes here..." class="p-4 rounded-md" rows="5" required></textarea>
                    <button type="submit" class="header-button">Post Notes</button>
                </form>
            </section>
            
            <section>
                <h2 class="text-3xl font-bold text-dark-orange mb-4">Enter Test Marks</h2>
                <form id="marks-form" class="flex flex-col space-y-4">
                    <select id="marks-student" required>
                        <option value="" disabled selected>Select Student</option>
                    </select>
                    <input type="text" id="marks-subject" placeholder="Subject" required>
                    <input type="number" id="marks-score" placeholder="Score" min="0" max="100" required>
                    <button type="submit" class="header-button">Submit Marks</button>
                </form>
            </section>
        </main>
    </div>

    <div id="password-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-crimson mb-4">Change Password</h3>
            <form id="change-password-form" class="flex flex-col space-y-4">
                <input type="password" id="old-password" placeholder="Current Password" required>
                <input type="password" id="new-password" placeholder="New Password" required>
                <input type="password" id="confirm-new-password" placeholder="Confirm New Password" required>
                <p id="password-message" class="text-center text-sm hidden"></p>
                <div class="flex justify-between space-x-2">
                    <button type="submit" class="header-button w-full">Save</button>
                    <button type="button" id="cancel-password-change" class="header-button logout-btn w-full">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="username-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-crimson mb-4">Change Username</h3>
            <form id="change-username-form" class="flex flex-col space-y-4">
                <input type="text" id="new-username" placeholder="New Username" required>
                <input type="password" id="confirm-password-username" placeholder="Confirm Password" required>
                <p id="username-message" class="text-center text-sm hidden"></p>
                <div class="flex justify-between space-x-2">
                    <button type="submit" class="header-button w-full">Save</button>
                    <button type="button" id="cancel-username-change" class="header-button logout-btn w-full">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function renderStudentsAndComments() {
            const users = JSON.parse(localStorage.getItem('users')) || {};
            const studentListElement = document.getElementById('student-list');
            const commentsListElement = document.getElementById('comments-list');
            const marksStudentSelect = document.getElementById('marks-student');
            
            studentListElement.innerHTML = '';
            commentsListElement.innerHTML = '';
            marksStudentSelect.innerHTML = '<option value="" disabled selected>Select Student</option>';

            const students = Object.keys(users)
                .map(username => ({ username, ...users[username] }))
                .filter(user => user.role === 'student');

            if (students.length > 0) {
                students.forEach(student => {
                    // Create the main student card
                    const studentCard = document.createElement('div');
                    studentCard.className = 'card flex flex-col justify-between';
                    studentCard.dataset.username = student.username; // Use data-attribute for reference
                    
                    const header = document.createElement('div');
                    header.className = 'flex justify-between items-center student-card';
                    header.innerHTML = `
                        <div>
                            <p class="text-xl font-bold text-crimson">${student.name}</p>
                            <p class="text-md text-[#3C3744] mt-1">Username: ${student.username}</p>
                        </div>
                    `;
                    
                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = 'student-details space-y-4';
                    
                    // Add student details
                    detailsDiv.innerHTML = `
                        <h3 class="text-2xl font-bold text-dark-orange mt-4">Marks for ${student.name}</h3>
                        <table class="marks-table">
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>Score</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    `;
                    studentCard.appendChild(header);
                    studentCard.appendChild(detailsDiv);
                    studentListElement.appendChild(studentCard);

                    // Add to marks dropdown
                    const studentOption = document.createElement('option');
                    studentOption.value = student.username;
                    studentOption.textContent = student.name;
                    marksStudentSelect.appendChild(studentOption);
                });
            } else {
                studentListElement.innerHTML = '<p class="text-center text-gray-500">No students are currently registered.</p>';
            }
            
            // Render the student details and marks when a student card is clicked
            document.querySelectorAll('.student-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const parentCard = card.closest('.card');
                    const username = parentCard.dataset.username;
                    const detailsDiv = parentCard.querySelector('.student-details');
                    
                    // Toggle visibility of the details div
                    detailsDiv.classList.toggle('visible');

                    if (detailsDiv.classList.contains('visible')) {
                        renderStudentMarks(username, detailsDiv);
                    }
                });
            });

            // Render parent comments
            const comments = JSON.parse(localStorage.getItem('comments')) || {};
            let hasComments = false;
            if (Object.keys(comments).length > 0) {
                for (const studentUsername in comments) {
                    const studentName = users[studentUsername] ? users[studentUsername].name : studentUsername;
                    comments[studentUsername].forEach(comment => {
                        const commentCard = document.createElement('div');
                        commentCard.className = 'card';
                        commentCard.innerHTML = `
                            <p class="text-xl font-bold text-crimson">${studentName}'s parent commented:</p>
                            <p class="text-md text-[#3C3744] mt-1">"${comment}"</p>
                        `;
                        commentsListElement.appendChild(commentCard);
                        hasComments = true;
                    });
                }
            }
            if (!hasComments) {
                commentsListElement.innerHTML = '<p class="text-center text-gray-500">No new comments from parents.</p>';
            }
        }
        
        // Function to render and manage a specific student's marks
        function renderStudentMarks(username, container) {
            const allMarks = JSON.parse(localStorage.getItem('marks')) || {};
            const studentMarks = allMarks[username] || [];
            const tbody = container.querySelector('tbody');
            tbody.innerHTML = '';
            
            if (studentMarks.length > 0) {
                studentMarks.forEach((mark, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="text-crimson">${mark.subject}</td>
                        <td class="mark-score">${mark.score}</td>
                        <td>
                            <button class="action-button edit-mark-btn" data-index="${index}" data-username="${username}">Edit</button>
                            <button class="action-button delete-mark-btn delete" data-index="${index}" data-username="${username}">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500">No marks available.</td></tr>`;
            }

            // Event listeners for Edit and Delete buttons
            container.querySelectorAll('.edit-mark-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const username = e.target.dataset.username;
                    const scoreCell = e.target.closest('tr').querySelector('.mark-score');
                    const currentScore = scoreCell.textContent;

                    // If already in edit mode, save the new score
                    if (e.target.textContent === 'Save') {
                        const newScore = scoreCell.querySelector('input').value;
                        if (newScore !== null && newScore !== '') {
                            const marks = JSON.parse(localStorage.getItem('marks')) || {};
                            marks[username][index].score = newScore;
                            localStorage.setItem('marks', JSON.stringify(marks));
                            renderStudentMarks(username, container); // Re-render to show updated score
                        }
                    } else { // Enter edit mode
                        // Replace text with an input field
                        scoreCell.innerHTML = `<input type="number" class="w-20 p-1" value="${currentScore}" />`;
                        e.target.textContent = 'Save';
                        e.target.classList.remove('edit-mark-btn');
                        e.target.classList.add('save-mark-btn');
                    }
                });
            });

            container.querySelectorAll('.delete-mark-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const username = e.target.dataset.username;
                    if (confirm('Are you sure you want to delete this mark?')) {
                        const marks = JSON.parse(localStorage.getItem('marks')) || {};
                        marks[username].splice(index, 1);
                        localStorage.setItem('marks', JSON.stringify(marks));
                        // Re-render the marks for this student
                        renderStudentMarks(username, container);
                    }
                });
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const teacherNameElement = document.getElementById('teacher-name');
            const assignmentForm = document.getElementById('assignment-form');
            const notesForm = document.getElementById('notes-form');
            const marksForm = document.getElementById('marks-form');
            const logoutBtn = document.getElementById('logout-btn');
            const deleteAccountBtn = document.getElementById('delete-account-btn');
            const changePasswordBtn = document.getElementById('change-password-btn');
            const changeUsernameBtn = document.getElementById('change-username-btn');
            const passwordModal = document.getElementById('password-modal');
            const usernameModal = document.getElementById('username-modal');
            const cancelPasswordChangeBtn = document.getElementById('cancel-password-change');
            const cancelUsernameChangeBtn = document.getElementById('cancel-username-change');
            const changePasswordForm = document.getElementById('change-password-form');
            const changeUsernameForm = document.getElementById('change-username-form');
            const passwordMessageElement = document.getElementById('password-message');
            const usernameMessageElement = document.getElementById('username-message');
            const menuToggleBtn = document.getElementById('menu-toggle-btn');
            const menuDropdown = document.getElementById('menu-dropdown');
            const toggleStudentsBtn = document.getElementById('toggle-students');
            const toggleCommentsBtn = document.getElementById('toggle-comments');

            menuToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                menuDropdown.classList.toggle('hidden');
            });

            window.addEventListener('click', (e) => {
                if (!menuToggleBtn.contains(e.target) && !menuDropdown.contains(e.target)) {
                    menuDropdown.classList.add('hidden');
                }
            });

            if (!currentUser || currentUser.role !== 'teacher') {
                alert('Access denied. Please log in as a teacher.');
                window.location.href = 'index.html';
                return;
            }

            teacherNameElement.textContent = currentUser.name;
            renderStudentsAndComments();

            // Toggle sections
            document.getElementById('toggle-students').addEventListener('click', () => {
                document.getElementById('student-list').classList.toggle('hidden');
            });
            document.getElementById('toggle-comments').addEventListener('click', () => {
                document.getElementById('comments-list').classList.toggle('hidden');
            });

            assignmentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const title = document.getElementById('assignment-title').value;
                const subject = document.getElementById('assignment-subject').value;
                const dueDate = document.getElementById('assignment-due-date').value;
                const assignments = JSON.parse(localStorage.getItem('assignments')) || [];
                assignments.push({ title, subject, dueDate });
                localStorage.setItem('assignments', JSON.stringify(assignments));
                alert('Assignment successfully created!');
                assignmentForm.reset();
            });

            notesForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const title = document.getElementById('note-title').value;
                const content = document.getElementById('note-content').value;
                const notes = JSON.parse(localStorage.getItem('notes')) || [];
                notes.push({ title, content });
                localStorage.setItem('notes', JSON.stringify(notes));
                alert('Notes successfully posted!');
                notesForm.reset();
            });
            
            marksForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const studentUsername = document.getElementById('marks-student').value;
                const subject = document.getElementById('marks-subject').value;
                const score = document.getElementById('marks-score').value;

                const marks = JSON.parse(localStorage.getItem('marks')) || {};
                if (!marks[studentUsername]) {
                    marks[studentUsername] = [];
                }
                marks[studentUsername].push({ subject, score });
                localStorage.setItem('marks', JSON.stringify(marks));

                alert(`Marks for ${subject} submitted for ${studentUsername}.`);
                marksForm.reset();
            });

            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            });

            deleteAccountBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to delete your account? This cannot be undone.')) {
                    const users = JSON.parse(localStorage.getItem('users')) || {};
                    if (users[currentUser.username]) {
                        delete users[currentUser.username];
                        localStorage.setItem('users', JSON.stringify(users));
                    }
                    localStorage.removeItem('currentUser');
                    alert('Your account has been deleted.');
                    window.location.href = 'index.html';
                }
            });

            changePasswordBtn.addEventListener('click', () => {
                passwordModal.classList.remove('hidden');
                menuDropdown.classList.add('hidden');
            });

            cancelPasswordChangeBtn.addEventListener('click', () => {
                passwordModal.classList.add('hidden');
                changePasswordForm.reset();
                passwordMessageElement.classList.add('hidden');
            });
            
            changePasswordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const oldPassword = document.getElementById('old-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmNewPassword = document.getElementById('confirm-new-password').value;

                if (oldPassword !== currentUser.password) {
                    passwordMessageElement.textContent = 'Current password is incorrect.';
                    passwordMessageElement.classList.remove('hidden');
                    passwordMessageElement.style.color = '#DC143C';
                    return;
                }

                if (newPassword !== confirmNewPassword) {
                    passwordMessageElement.textContent = 'New passwords do not match.';
                    passwordMessageElement.classList.remove('hidden');
                    passwordMessageElement.style.color = '#DC143C';
                    return;
                }

                const users = JSON.parse(localStorage.getItem('users')) || {};
                users[currentUser.username].password = newPassword;
                localStorage.setItem('users', JSON.stringify(users));
                
                currentUser.password = newPassword;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                passwordMessageElement.textContent = 'Password changed successfully!';
                passwordMessageElement.classList.remove('hidden');
                passwordMessageElement.style.color = 'green';
                
                setTimeout(() => {
                    passwordModal.classList.add('hidden');
                    changePasswordForm.reset();
                    passwordMessageElement.classList.add('hidden');
                    passwordMessageElement.style.color = '#DC143C';
                }, 2000);
            });
            
            changeUsernameBtn.addEventListener('click', () => {
                usernameModal.classList.remove('hidden');
                menuDropdown.classList.add('hidden');
            });

            cancelUsernameChangeBtn.addEventListener('click', () => {
                usernameModal.classList.add('hidden');
                changeUsernameForm.reset();
                usernameMessageElement.classList.add('hidden');
            });
            
            changeUsernameForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newUsername = document.getElementById('new-username').value;
                const confirmPassword = document.getElementById('confirm-password-username').value;
                
                const users = JSON.parse(localStorage.getItem('users')) || {};

                if (confirmPassword !== currentUser.password) {
                    usernameMessageElement.textContent = 'Incorrect password.';
                    usernameMessageElement.classList.remove('hidden');
                    usernameMessageElement.style.color = '#DC143C';
                    return;
                }

                if (users[newUsername]) {
                    usernameMessageElement.textContent = 'Username is already taken.';
                    usernameMessageElement.classList.remove('hidden');
                    usernameMessageElement.style.color = '#DC143C';
                    return;
                }
                
                const oldUsername = currentUser.username;
                const userData = users[oldUsername];
                
                delete users[oldUsername];
                users[newUsername] = userData;
                localStorage.setItem('users', JSON.stringify(users));
                
                const allMarks = JSON.parse(localStorage.getItem('marks')) || {};
                if (allMarks[oldUsername]) {
                    allMarks[newUsername] = allMarks[oldUsername];
                    delete allMarks[oldUsername];
                    localStorage.setItem('marks', JSON.stringify(allMarks));
                }

                for (const user in users) {
                    if (users[user].role === 'parent' && users[user].linkedChild === oldUsername) {
                        users[user].linkedChild = newUsername;
                    }
                }
                localStorage.setItem('users', JSON.stringify(users));
                
                currentUser.username = newUsername;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                usernameMessageElement.textContent = 'Username changed successfully!';
                usernameMessageElement.classList.remove('hidden');
                usernameMessageElement.style.color = 'green';
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            });
        });
    </script>
</body>
</html>